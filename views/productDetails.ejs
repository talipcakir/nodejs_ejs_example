<%- include('partials/header') %>
<%- include('partials/navbar') %>

<div class="container my-4 d-none d-lg-block">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="/products">Catalog</a></li>
            <li class="breadcrumb-item"><a href="#" id="breadcrumb-category">Category</a></li>
            <li class="breadcrumb-item active" aria-current="page" id="breadcrumb-title">Product Name</li>
        </ol>
    </nav>
</div>

<main class="container my-5">
    <div class="row g-5">
        <div class="col-lg-6">
            <div class="row">
                <div class="col-12 text-center mb-3 order-lg-2">
                    <img src="" id="main-product-image" class="img-fluid rounded" alt="Main product" style="max-height: 500px;">
                </div>
                <div class="col-12 order-lg-1">
                    <div class="d-flex flex-row flex-lg-column justify-content-center gap-2" id="product-thumbnails">
                        </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <h1 class="display-5 fw-bold" id="product-title">Ürün Adı Yükleniyor...</h1>
            <div class="d-flex align-items-center gap-3 my-3">
                <span class="fs-2 fw-bold" id="product-price">$0.00</span>
                <span class="fs-4 text-muted text-decoration-line-through" id="discount-price">$0.00</span>
            </div>

            <hr>

            <div class="mb-3">
                <p class="mb-2">Select color:</p>
                <div class="d-flex gap-2">
                    <button class="btn rounded-circle" style="width: 32px; height: 32px; background-color: #000000; border: 2px solid #fff;"></button>
                    <button class="btn rounded-circle" style="width: 32px; height: 32px; background-color: #781DBC; border: 2px solid #fff;"></button>
                    <button class="btn rounded-circle" style="width: 32px; height: 32px; background-color: #E10000; border: 2px solid #fff;"></button>
                    </div>
            </div>

            <div class="mb-3">
                 <p class="mb-2">Memory:</p>
                 <div class="btn-group w-100" role="group" aria-label="Memory selection">
                    <input type="radio" class="btn-check" name="memory" id="mem128" autocomplete="off" checked>
                    <label class="btn btn-outline-secondary" for="mem128">128GB</label>

                    <input type="radio" class="btn-check" name="memory" id="mem256" autocomplete="off">
                    <label class="btn btn-outline-secondary" for="mem256">256GB</label>
                    
                    <input type="radio" class="btn-check" name="memory" id="mem512" autocomplete="off">
                    <label class="btn btn-outline-secondary" for="mem512">512GB</label>

                    <input type="radio" class="btn-check" name="memory" id="mem1tb" autocomplete="off">
                    <label class="btn btn-outline-secondary" for="mem1tb">1TB</label>
                </div>
            </div>

            <div class="row g-2 mb-3">
                <div class="col-6">
                    <div class="card card-body bg-light border-0 p-2">
                        <div class="d-flex align-items-center">
                            <img src="/photo/Screensize.png" class="me-2" style="width: 24px;">
                            <div>
                                <span class="d-block small">Screen size</span>
                                <span class="d-block fw-bold small">6.7"</span>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

            <p class="text-muted" id="description">Açıklama yükleniyor...</p>

            <div class="row g-2 mt-4">
                <div class="col-md-6">
                    <button class="btn btn-outline-dark w-100 btn-lg">Add to Wishlist</button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-dark w-100 btn-lg" id="addToCartBtn">Add to Cart</button>
                </div>
            </div>

            <div class="row g-3 text-center mt-4">
                <div class_ ="col-4">
                    <div class="bg-light rounded p-3">
                        <img src="/photo/delivery-truck-svgrepo-com (1) 1.png" class="mb-2" style="width: 40px;">
                        <p class="mb-0 small">Free Delivery<br>1-3 Days</p>
                    </div>
                </div>
                 <div class="col-4">
                    <div class="bg-light rounded p-3">
                        <img src="/photo/shop-2-svgrepo-com 2.png" class="mb-2" style="width: 40px;">
                        <p class="mb-0 small">In Stock<br>Today</p>
                    </div>
                </div>
                 <div class="col-4">
                    <div class="bg-light rounded p-3">
                        <img src="/photo/verify.png" class="mb-2" style="width: 40px;">
                        <p class="mb-0 small">Guaranteed<br>1 year</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-5">

    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <nav>
                <div class="nav nav-tabs justify-content-center fs-5" id="nav-tab" role="tablist">
                    <button class="nav-link active" id="nav-details-tab" data-bs-toggle="tab" data-bs-target="#nav-details" type="button" role="tab" aria-controls="nav-details" aria-selected="true">Details</button>
                    <button class="nav-link" id="nav-reviews-tab" data-bs-toggle="tab" data-bs-target="#nav-reviews" type="button" role="tab" aria-controls="nav-reviews" aria-selected="false">Reviews</button>
                </div>
            </nav>
            <div class="tab-content bg-white p-4 p-md-5 rounded-bottom" id="nav-tabContent">
                
                <div class="tab-pane fade show active" id="nav-details" role="tabpanel" aria-labelledby="nav-details-tab">
                    <h3 class="mb-4">Details</h3>
                    <p class="text-muted" id="descriptionMain">Tam açıklama yükleniyor...</p>
                    
                    <h4 class="mt-5 mb-3">Screen</h4>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between"><span>Screen diagonal:</span> <span>6.7"</span></li>
                        <li class="list-group-item d-flex justify-content-between"><span>The screen resolution</span> <span>2796x1290</span></li>
                        <li class="list-group-item d-flex justify-content-between"><span>The screen refresh rate</span> <span>120 Hz</span></li>
                        <li class="list-group-item d-flex justify-content-between"><span>The pixel density</span> <span>460 ppi</span></li>
                        <li class="list-group-item d-flex justify-content-between"><span>Screen type</span> <span>OLED</span></li>
                    </ul>
                    </div>
                
                <div class="tab-pane fade" id="nav-reviews" role="tabpanel" aria-labelledby="nav-reviews-tab">
                    <h3 class="mb-4">Reviews</h3>
                    
                    <div class="card bg-light border-0 mb-4">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-4 text-center border-end-md">
                                    <h1 class="display-3 fw-bold">4.8</h1>
                                    <div class="fs-4 mb-2">
                                        </div>
                                    <p class="text-muted mb-0">of 125 reviews</p>
                                </div>
                                <div class="col-md-8 px-4">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <span class="small" style="min-width: 100px;">Excellent</span>
                                        <div class="progress flex-grow-1" style="height: 10px;">
                                            <div class="progress-bar bg-warning" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <span class="small text-muted">100</span>
                                    </div>
                                    </div>
                            </div>
                        </div>
                    </div>

                    <textarea class="form-control mb-4" rows="3" placeholder="Leave Comment"></textarea>

                    <div class="d-flex mb-4">
                        <img src="/photo/User Pic.png" class="rounded-circle me-3" style="width: 56px; height: 56px;" alt="User">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <h5 class="mb-0">Grace Carey</h5>
                                <span class="small text-muted">24 January 2023</span>
                            </div>
                            <div class="mb-2"></div>
                            <p class="text-muted">I was a bit nervous to be buying a secondhand phone from Amazon, but I couldn’t be happier with my purchase!!...</p>
                        </div>
                    </div>
                    </div>
            </div>
        </div>
    </div>

    <hr class="my-5">

    <div class="row">
        <h2 class="fs-1 mb-4">Related Products</h2>
        <div class="row g-3 product-list-container" id="productpagedetails">
            </div>
    </div>
</main>

<script>
    // ProductDetails.html'den alınan orijinal script
    document.addEventListener("DOMContentLoaded", () => {
        // server.js'den EJS aracılığıyla gelen productId'yi al
        const productId = '<%= productId %>'; 

        if (productId) {
            fetch(`https://fakestoreapi.com/products/${productId}`)
                .then(res => res.json())
                .then(product => {
                    // Ana resmi güncelle
                    document.getElementById("main-product-image").src = product.image;
                    document.getElementById("main-product-image").alt = product.title;

                    // Thumbnail'leri (küçük resimler) oluştur
                    const thumbnailContainer = document.getElementById("product-thumbnails");
                    thumbnailContainer.innerHTML = ''; // Önce temizle
                    for (let i = 0; i < 4; i++) {
                        thumbnailContainer.innerHTML += `
                            <img src="${product.image}" class="img-thumbnail" style="width: 75px; height: 66px; opacity: ${i === 0 ? 1 : 0.5}; cursor:pointer;" alt="thumbnail">
                        `;
                    }

                    // Breadcrumb'ları güncelle
                    document.getElementById("breadcrumb-category").textContent = product.category;
                    document.getElementById("breadcrumb-title").textContent = product.title;
                    
                    // Ürün bilgilerini güncelle
                    document.getElementById("product-title").textContent = product.title;
                    document.getElementById("product-price").textContent = `$${product.price}`;
                    document.getElementById("discount-price").textContent = `$${(product.price * 1.10).toFixed(2)}`;
                    
                    // Açıklamaları güncelle
                    const fullDescription = product.description;
                    const halfLength = Math.floor(fullDescription.length / 2);
                    const halfDescription = fullDescription.substring(0, halfLength);
                    document.getElementById("description").textContent = halfDescription + "...";
                    document.getElementById("descriptionMain").textContent = fullDescription;

                    // Sepete Ekle Butonu
                    document.getElementById('addToCartBtn').addEventListener('click', () => {
                        let cart = JSON.parse(localStorage.getItem('cart')) || {};

                        if (cart[productId]) {
                            cart[productId].quantity += 1;
                        } else {
                            cart[productId] = {
                                title: product.title,
                                price: product.price,
                                quantity: 1,
                                image: product.image
                            };
                        }
                        localStorage.setItem('cart', JSON.stringify(cart));
                        alert(`${product.title} sepete eklendi!`);
                    });
                })
                .catch(err => console.error("Ürün yüklenirken hata:", err));
        }

        // İlgili ürünleri yükle (Ayrı fonksiyon)
        function loadRelatedProducts(limit, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            fetch("https://fakestoreapi.com/products")
                .then(response => response.json())
                .then(data => {
                    data.slice(0, limit).forEach(product => {
                        const cardWrapper = document.createElement("div");
                        cardWrapper.className = "col-6 col-md-4 col-lg-3"; // 4'lü grid

                        const card = document.createElement("div");
                        card.className = "card h-100 text-center border-0 productcard";

                        card.innerHTML = `
                            <div class="card-header bg-transparent border-0 text-end productcardtop">
                                <img src="/photo/Like.png" alt="Like" style="width:32px; height:32px; cursor:pointer;">
                            </div>
                            <div class="productcardphoto d-flex align-items-center justify-content-center" style="height: 160px;">
                                <img src="${product.image}" alt="${product.title}" class="card-img-top img-fluid" style="max-height: 100%; width: auto; max-width: 100%;">
                            </div>
                            <div class="card-body d-flex flex-column productcarddescription">
                                <h4 class="card-title fs-6 text-truncate" style="min-height: 48px;">${product.title}</h4>
                                <p class="card-text fs-4 fw-bold my-3">$${product.price}</p>
                                <button class="btn btn-dark w-100 mt-auto buybutton">Buy Now</button>
                            </div>
                        `;
                        
                        cardWrapper.appendChild(card);
                        container.appendChild(cardWrapper);

                        const buyBtn = card.querySelector(".buybutton");
                        buyBtn.addEventListener("click", () => {
                            window.location.href = `/product/${product.id}`;
                        });
                    });
                })
                .catch(err => console.error("Ürünler yüklenirken hata oluştu:", err));
        }
        loadRelatedProducts(4, "productpagedetails");
    });
</script>

<%- include('partials/footer') %>