<%- include('partials/header') %>
<%- include('partials/navbar') %>

<div class="container my-4 d-none d-lg-block">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="/products">Catalog</a></li>
            <li class="breadcrumb-item"><a href="#" id="breadcrumb-category"><%= product.category %></a></li>
            <li class="breadcrumb-item active" aria-current="page" id="breadcrumb-title"><%= product.title %></li>
        </ol>
    </nav>
</div>

<main class="container my-5">
    <div class="row g-5">
        <div class="col-lg-6">
            <div class="row">
                <div class="col-12 text-center mb-3 order-lg-2">
                    <img src="<%= product.image %>" id="main-product-image" class="img-fluid rounded" alt="<%= product.title %>" style="max-height: 500px;">
                </div>
                <div class="col-12 order-lg-1">
                    <div class="d-flex flex-row flex-lg-column justify-content-center gap-2" id="product-thumbnails">
                        <% for (let i = 0; i < 4; i++) { %>
                            <img src="<%= product.image %>" class="img-thumbnail" style="width: 75px; height: 66px; opacity: <%= i === 0 ? 1 : 0.5 %>; cursor:pointer;" alt="thumbnail">
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <h1 class="display-5 fw-bold" id="product-title"><%= product.title %></h1>
            <div class="d-flex align-items-center gap-3 my-3">
                <span class="fs-2 fw-bold" id="product-price">$<%= product.price %></span>
                <span class="fs-4 text-muted text-decoration-line-through" id="discount-price">$<%= (product.price * 1.10).toFixed(2) %></span>
            </div>

            <hr>
            <p class="text-muted" id="description"><%= product.description.substring(0, 200) %>...</p>

            <div class="row g-2 mt-4">
                <div class="col-md-6">
                    <button class="btn btn-outline-dark w-100 btn-lg">Add to Wishlist</button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-dark w-100 btn-lg" id="addToCartBtn">Add to Cart</button>
                </div>
            </div>
            
            </div>
    </div>

    <hr class="my-5">

    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="tab-content bg-white p-4 p-md-5 rounded-bottom" id="nav-tabContent">
                
                <div class="tab-pane fade show active" id="nav-details" role="tabpanel" aria-labelledby="nav-details-tab">
                    <h3 class="mb-4">Details</h3>
                    <p class="text-muted" id="descriptionMain"><%= product.description %></p>
                    </div>
                
                <div class="tab-pane fade" id="nav-reviews" role="tabpanel" aria-labelledby="nav-reviews-tab">
                    </div>
            </div>
        </div>
    </div>

    <hr class="my-5">

    <div class="row">
        <h2 class="fs-1 mb-4">Related Products</h2>
        <div class="row g-3 product-list-container" id="productpagedetails">
            <% if (typeof relatedProducts !== 'undefined' && relatedProducts.length > 0) { %>
                <% relatedProducts.forEach(relProduct => { %>
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card h-100 text-center border-0 productcard">
                            <div class="card-header bg-transparent border-0 text-end productcardtop">
                                <img src="/photo/Like.png" alt="Like" style="width:32px; height:32px; cursor:pointer;">
                            </div>
                            <div class="productcardphoto d-flex align-items-center justify-content-center" style="height: 160px;">
                                <img src="<%= relProduct.image %>" alt="<%= relProduct.title %>" class="card-img-top img-fluid" style="max-height: 100%; width: auto; max-width: 100%;">
                            </div>
                            <div class="card-body d-flex flex-column productcarddescription">
                                <h4 class="card-title fs-6 text-truncate" style="min-height: 48px;"><%= relProduct.title %></h4>
                                <p class="card-text fs-4 fw-bold my-3">$<%= relProduct.price %></p>
                                <a href="/product/<%= relProduct.id %>" class="btn btn-dark w-100 mt-auto buybutton">Buy Now</a>
                            </div>
                        </div>
                    </div>
                <% }); %>
            <% } %>
        </div>
    </div>
</main>

<script type="text/javascript">
    // Sunucudan gelen 'product' objesini alıp bir client-side JS değişkenine atıyoruz.
    const product = <%- JSON.stringify(product) %>;

    document.addEventListener("DOMContentLoaded", () => {
        
        // Sepete Ekle Butonu (Bu hala client-side kalmalı)
        document.getElementById('addToCartBtn').addEventListener('click', () => {
            const productId = product.id.toString(); // ID'yi string'e çevir
            
            let cart = JSON.parse(localStorage.getItem('cart')) || {};

            if (cart[productId]) {
                cart[productId].quantity += 1;
            } else {
                cart[productId] = {
                    title: product.title,
                    price: product.price,
                    quantity: 1,
                    image: product.image
                };
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            alert(`${product.title} sepete eklendi!`);
        });

        // (Varsa) Thumbnail tıklama olayları gibi diğer client-side etkileşimler buraya eklenebilir.
    });
</script>

<%- include('partials/footer') %>