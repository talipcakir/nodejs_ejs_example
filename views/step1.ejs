<%- include('partials/header') %>
<%- include('partials/navbar') %>

<div class="container py-5">
    <div class="row g-3 text-center">
        <div class="col-4">
            <div class="text-primary">
                <img src="/photo/Location.png" alt="Address">
                <p class="mb-0 small">Step 1</p>
                <p class="fs-5 mb-0">Address</p>
            </div>
        </div>
        <div class="col-4">
             <div class="text-muted">
                <img src="/photo/Shipping.png" alt="Shipping">
                <p class="mb-0 small">Step 2</p>
                <p class="fs-5 mb-0">Shipping</p>
            </div>
        </div>
        <div class="col-4">
             <div class="text-muted">
                <img src="/photo/Payment.png" alt="Payment">
                <p class="mb-0 small">Step 3</p>
                <p class="fs-5 mb-0">Payment</p>
            </div>
        </div>
    </div>
</div>

<main class="container mb-5">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4 p-md-5">
                    <h3 class="mb-4">Select Address</h3>
                    
                    <div id="addressList" class="mb-4" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center p-5">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 border-top pt-4">
                         <button class="btn btn-outline-primary btn-lg">
                            <i class="bi bi-plus-circle-dotted"></i> Add New Address
                         </button>
                    </div>

                    <div class="d-flex justify-content-between mt-5">
                        <a href="/cart" class="btn btn-outline-secondary btn-lg" style="min-width: 120px;">Back</a>
                        <a href="/step2" class="btn btn-dark btn-lg" style="min-width: 120px;">Next</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
// Step1.html'den alınan orijinal script (Bootstrap ile güncellendi)
document.addEventListener('DOMContentLoaded', () => {
    fetch('https://fakestoreapi.com/users')
        .then(res => res.json())
        .then(users => {
            const container = document.getElementById("addressList");
            if (!container) return;
            container.innerHTML = ''; // Spinner'ı temizle

            users.forEach((user, index) => {
                const card = document.createElement("div");
                // Tıklanabilir kart yapısı
                card.className = "card mb-3 address-card";
                card.style.cursor = "pointer";

                card.innerHTML = `
                    <div class="card-body p-3">
                        <div class="row g-2">
                            <div class="col-auto d-flex align-items-center">
                                <input class="form-check-input" type="radio" name="selectedAddress" id="addr-${index}" value="${index}">
                            </div>
                            
                            <div class="col">
                                <label class="form-check-label w-100" for="addr-${index}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0 fs-6 fw-bold">${user.name.firstname} ${user.name.lastname}</h5>
                                        <span class="badge bg-dark">USER</span>
                                    </div>
                                    <p class="text-muted mb-1 small">
                                        ${user.address.number} ${user.address.street}, 
                                        ${user.address.city}, 
                                        ${user.address.zipcode}
                                    </p>
                                    <p class="text-muted mb-0 small">${user.phone}</p>
                                </label>
                            </div>
                            
                            <div class="col-auto d-flex align-items-center">
                                <button class="btn btn-sm btn-outline-danger delete-btn border-0">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);

                // Tüm karta tıklanınca radio'yu seç ve kartı vurgula
                card.addEventListener("click", (e) => {
                    if (e.target.classList.contains("delete-btn") || e.target.closest(".delete-btn")) {
                        // Silme butonuysa bir şey yapma (silme olayı halledecek)
                        return;
                    }

                    // Tüm kartlardan 'selected' sınıfını kaldır
                    document.querySelectorAll(".address-card").forEach(c => c.classList.remove("selected"));
                    // Bu karta 'selected' sınıfı ekle
                    card.classList.add("selected");
                    
                    // İlgili radio'yu seç
                    const radio = card.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.checked = true;

                        // Adresi localStorage'a kaydet
                        const addressData = {
                            name: `${user.name.firstname} ${user.name.lastname}`,
                            address: `${user.address.number} ${user.address.street}, ${user.address.city}, ${user.address.zipcode}`,
                            phone: user.phone
                        };
                        localStorage.setItem("selectedAddress", JSON.stringify(addressData));
                    }
                });

                // Silme butonuna tıklandığında
                card.querySelector(".delete-btn").addEventListener("click", () => {
                    card.remove();
                    // İlgili adres seçiliyse localStorage'dan temizle
                    const radio = card.querySelector('input[type="radio"]');
                    if(radio && radio.checked) {
                        localStorage.removeItem("selectedAddress");
                    }
                });
            });
        })
        .catch(err => {
            console.error("Hata:", err);
            const container = document.getElementById("addressList");
            if(container) container.innerHTML = "<p class='text-danger text-center'>Adresler yüklenemedi.</p>";
        });
});
</script>

<%- include('partials/footer') %>